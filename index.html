<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浪漫圣诞夜 - 互动小说</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            overflow-x: hidden;
            background: #000;
            position: relative;
        }

        /* 雪花背景动效 */
        .snowfall-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            color: white;
            font-size: 1em;
            animation: snowfall linear infinite;
            opacity: 0.8;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(-100vh) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* 主界面容器 */
        .novel-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: url('user_input_files/1.png') center/cover no-repeat;
            transition: background-image 0.8s ease-in-out;
        }

        /* 渐变遮罩 */
        .novel-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(40, 10, 10, 0.1) 0%,
                rgba(40, 10, 10, 0.2) 55%,
                rgba(40, 10, 10, 0.5) 100%
            );
            pointer-events: none;
        }

        /* 顶部信息区 */
        .header {
            padding: 20px 16px 8px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chapter-title {
            font-family: 'Lora', serif;
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .chapter-subtitle {
            font-size: 12px;
            font-weight: 500;
            color: #E0E0E0;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        /* 进度条 */
        .progress-bar {
            width: 120px;
            height: 4px;
            background: #616161;
            border-radius: 2px;
            margin: 0 auto;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #D32F2F, #E57373);
            border-radius: 2px;
            transition: width 600ms cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 8px rgba(211, 47, 47, 0.6);
        }

        /* 中央场景展示区 */
        .scene-display {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            min-height: 0;
        }

        .scene-content {
            text-align: center;
            max-width: 600px;
        }

        .story-text {
            font-size: 16px;
            line-height: 1.7;
            color: #FFFFFF;
            background: rgba(10, 5, 5, 0.7);
            padding: 20px 24px;
            border-radius: 24px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 16px;
            transform: scale(0.8);
            animation: storyAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes storyAppear {
            to {
                transform: scale(1);
            }
        }

        /* 对话区域 */
        .dialogue-section {
            background: rgba(10, 5, 5, 0.8);
            backdrop-filter: blur(12px);
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dialogue-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
            padding-right: 8px;
        }

        .dialogue-container::-webkit-scrollbar {
            width: 4px;
        }

        .dialogue-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .dialogue-container::-webkit-scrollbar-thumb {
            background: #D32F2F;
            border-radius: 2px;
        }

        .dialogue-bubble {
            margin-bottom: 12px;
            animation: dialogueSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes dialogueSlide {
            from {
                transform: scale(0.8) translateY(10px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .dialogue-ai {
            text-align: left;
        }

        .dialogue-user {
            text-align: right;
        }

        .dialogue-ai .bubble {
            background: rgba(10, 5, 5, 0.7);
            border-radius: 24px 24px 24px 4px;
        }

        .dialogue-user .bubble {
            background: rgba(46, 125, 50, 0.6);
            border-radius: 24px 24px 4px 24px;
        }

        .bubble {
            display: inline-block;
            padding: 12px 16px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 80%;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .character-name {
            font-size: 12px;
            font-weight: 500;
            color: #E0E0E0;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }

        .dialogue-text {
            font-size: 15px;
            line-height: 1.6;
            color: #FFFFFF;
        }

        /* 输入区域 */
        .input-section {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 对话模式才显示输入区域 */
        .input-section.hidden {
            display: none;
        }

        /* 状态提示 */
        .status-indicator {
            text-align: center;
            margin: 10px 0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }

        .status-indicator.show {
            display: block;
        }

        .status-loading {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .status-error {
            background: rgba(255, 0, 0, 0.2);
            color: #FF6B6B;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .user-input {
            flex: 1;
            height: 48px;
            padding: 0 16px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(10, 5, 5, 0.7);
            color: #FFFFFF;
            font-size: 16px;
            backdrop-filter: blur(12px);
            transition: all 300ms ease-out;
        }

        .user-input:focus {
            outline: none;
            border: 1.5px solid #E57373;
            box-shadow: 0 0 12px rgba(211, 47, 47, 0.5);
        }

        .user-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* 思考动画 */
        .thinking-animation {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-start;
        }

        .dots {
            display: flex;
            gap: 2px;
        }

        .dots span {
            animation: dotBlink 1.4s infinite;
        }

        .dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dotBlink {
            0%, 20% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
        }

        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D32F2F, #B71C1C);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 250ms ease-out;
            box-shadow: 0 4px 16px rgba(211, 47, 47, 0.4);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.6);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        /* 继续按钮 */
        .continue-button {
            position: fixed;
            bottom: 32px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D32F2F, #B71C1C);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 250ms ease-out;
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.6);
            z-index: 10;
        }

        .continue-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(211, 47, 47, 0.8);
        }

        .continue-button:active {
            transform: scale(0.95);
        }

        .continue-button.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* 选择界面样式 */
        .interaction-choice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('user_input_files/1.png') center/cover no-repeat;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .interaction-choice::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(0, 0, 0, 0.85) 0%,
                rgba(0, 0, 0, 0.75) 30%,
                rgba(0, 0, 0, 0.65) 70%,
                rgba(139, 69, 19, 0.4) 100%
            );
            backdrop-filter: blur(2px);
            z-index: -1;
        }

        .choice-container {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 520px;
            width: 100%;
            text-align: center;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 40px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .choice-header {
            margin-bottom: 32px;
        }

        .adrian-portrait {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.4);
            object-fit: cover;
            margin: 0 auto 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .adrian-portrait:hover {
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.5),
                0 0 30px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-title {
            font-family: 'Lora', serif;
            font-size: 32px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 8px;
            text-shadow: 
                0 2px 12px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #ffffff, #ffb3ba, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        }

        .choice-title {
            font-family: 'Lora', serif;
            font-size: 28px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 12px;
            text-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.7),
                0 0 20px rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #FFFFFF, #F0F0F0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .choice-subtitle {
            font-size: 18px;
            color: #FFFFFF;
            margin: 0 0 32px 0;
            text-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.8),
                0 0 12px rgba(255, 255, 255, 0.3);
            font-weight: 400;
            line-height: 1.4;
            letter-spacing: 0.3px;
        }

        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .choice-option {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 24px 20px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .choice-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .choice-option:hover::before {
            left: 100%;
        }

        .choice-option:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #FFD700;
            transform: translateY(-4px);
            box-shadow: 
                0 15px 40px rgba(255, 215, 0, 0.4),
                0 0 30px rgba(255, 215, 0, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .choice-option:active {
            transform: translateY(-1px);
        }

        .option-icon {
            font-size: 36px;
            margin-bottom: 12px;
            text-align: center;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transition: all 0.3s ease;
        }

        .choice-option:hover .option-icon {
            transform: scale(1.1);
            filter: drop-shadow(0 4px 8px rgba(255, 107, 107, 0.4));
        }

        .option-title {
            font-family: 'Lora', serif;
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            margin: 0 0 8px 0;
            text-align: center;
            text-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.8),
                0 0 12px rgba(255, 255, 255, 0.3);
            letter-spacing: 0.5px;
        }

        .option-description {
            font-size: 16px;
            color: #F0F0F0;
            margin: 0;
            line-height: 1.5;
            text-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.7),
                0 0 8px rgba(255, 255, 255, 0.2);
            font-weight: 300;
        }

        /* 选项按钮样式 */
        .option-button {
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 8px 0;
            color: #FFFFFF !important;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            text-align: left;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .option-button:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(255, 215, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.3),
                0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .option-button:active {
            transform: translateY(0);
        }

        /* 响应式设计 */
        @media (min-width: 768px) {
            .novel-container {
                max-width: 640px;
                margin: 0 auto;
            }
        }

        /* 减少动画适配 */
        @media (prefers-reduced-motion: reduce) {
            .snowflake {
                animation: none;
            }
            
            .story-text,
            .dialogue-bubble {
                animation: none;
            }
        }
    </style>
</head>
<body>
    <!-- 雪花背景 -->
    <div class="snowfall-container" id="snowfallContainer"></div>

    <!-- 选择互动方式界面 -->
    <div class="interaction-choice" id="interactionChoice">
        <div class="choice-container">
            <div class="choice-header">
                <img src="user_input_files/adrian_character.png" alt="艾德里安" class="adrian-portrait">
                <h1 class="main-title">平行宇宙· 和艾德里安的圣诞日</h1>
                <h2 class="choice-title">选择你的互动方式</h2>
                <p class="choice-subtitle">如何与艾德里安开始你的浪漫圣诞之旅？</p>
            </div>
            
            <div class="choice-options">
                <div class="choice-option" id="dialogueChoice">
                    <div class="option-icon">💬</div>
                    <h3 class="option-title">自由对话</h3>
                    <p class="option-description">通过文字与艾德里安自由交流，表达你的想法和感受</p>
                </div>
                
                <div class="choice-option" id="optionChoice">
                    <div class="option-icon">🎯</div>
                    <h3 class="option-title">选择互动</h3>
                    <p class="option-description">通过选择题与艾德里安互动，每个选择都会带来不同的对话体验</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div class="novel-container" id="novelContainer">
        <!-- 顶部信息 -->
        <header class="header">
            <h1 class="chapter-title" id="chapterTitle">第一章：意外穿越</h1>
            <p class="chapter-subtitle" id="chapterSubtitle">温暖圣诞夜</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 8.33%"></div>
            </div>
        </header>

        <!-- 中央场景展示 -->
        <main class="scene-display">
            <div class="scene-content">
                <div class="story-text" id="storyText">
                    雪花纷飞的夜晚，你感到一阵眩晕。当视线重新清晰时，面前是一个完全不同的世界——一个充满圣诞魔法的欧洲小镇。身边站着一位英俊的男士，他正温柔地看着你，眼中满含惊喜...
                </div>
            </div>
        </main>

        <!-- 对话和输入区域 -->
        <section class="dialogue-section">
            <!-- 状态指示器 -->
            <div class="status-indicator" id="statusIndicator"></div>
            
            <div class="dialogue-container" id="dialogueContainer">
                <!-- 对话内容将动态添加到这里 -->
            </div>
            
            <div class="input-section" id="inputSection">
                <input 
                    type="text" 
                    class="user-input" 
                    id="userInput"
                    placeholder="作为女主角输入你的回应..."
                    maxlength="200"
                >
                <button class="send-button" id="sendButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </section>
    </div>

    <!-- 继续按钮 -->
    <button class="continue-button" id="continueButton">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <script>
        // MiniMax API配置
        const MINIMAX_CONFIG = {
            API_URL: 'https://api.minimaxi.com/v1/text/chatcompletion_v2',
            API_KEY: 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiLmnajnvo7njokiLCJVc2VyTmFtZSI6IuadqOe-jueOiSIsIkFjY291bnQiOiIiLCJTdWJqZWN0SUQiOiIxODgxMjAxNTI0ODk0MzUxMzg4IiwiUGhvbmUiOiIxNzYwMDIyMTg0NCIsIkdyb3VwSUQiOiIxODgxMjAxNTI0ODg1OTYyNzgwIiwiUGFnZU5hbWUiOiIiLCJNYWlsIjoiIiwiQ3JlYXRlVGltZSI6IjIwMjUtMTAtMzAgMTc6NTI6MDkiLCJUb2tlblR5cGUiOjEsImlzcyI6Im1pbmltYXgifQ.hEnEbgXveTGstkieIl2YLFh_JfQHMrnIrmy2LoLbai7pVb3ktNDXDG3yUZhF26mZ-GW0eQfcviSyaZ7-Ox-UZvWH23N0PmbjrjyN9wY4Kawyee9BXRetLffiuhEx5NEXOqgNgyEO4s83aI9nvwe_vA8RUY8L5bSJcnR042NReKWBSQXGxI23bpYw7Y_LHJKg3ia-dogib8ehKVEzuSVIcEiYezAzHxItvqzcwS88XrXYOW60N8SBO9QR3l0T8XHo-CfDzBRVeoEpYphwVbnLsugcXyxZly1zoenS4wLkLdyU_JahG-zLQFB5KvD3Sp9VCN68TZUcowbrxRlhaFhBA',
            MODEL: 'abab6.5s-chat'
        };

        let conversationHistory = []; // 对话历史，用于自由对话模式

        // 章节数据
        const chapters = [
            {
                id: 1,
                title: "第一章：意外穿越",
                subtitle: "温暖圣诞夜",
                background: "user_input_files/1.png",
                story: "雪花纷飞的夜晚，你感到一阵眩晕。当视线重新清晰时，面前是一个完全不同的世界——一个充满圣诞魔法的欧洲小镇。身边站着一位英俊的男士，他正温柔地看着你，眼中满含惊喜...",
                aiIntro: [
                    { character: "艾德里安", text: "亲爱的，你还好吗？我是新来的吗？看起来你和我一样，对这里感到陌生。" },
                    { character: "艾德里安", text: "这里似乎是一个圣诞小镇...很美，不是吗？也许是某种魔法让我们来到了这里。" }
                ]
            },
            {
                id: 2,
                title: "第二章：圣诞集市初体验",
                subtitle: "温暖热红酒",
                background: "user_input_files/2.png",
                story: "你们一同走向灯火通明的圣诞市集。空气中弥漫着香料和热红酒的香气，摊位上摆满了精美的手工艺品和节日装饰。艾德里安温柔地为你递上一杯冒着热气的红酒...",
                aiIntro: [
                    { character: "艾德里安", text: "来，试试这个热红酒。我们一起温暖一下身心。这香料的味道真的很棒。" },
                    { character: "艾德里安", text: "在这样的夜晚，有你在身边，感觉特别温暖。特别是在这个神奇的小镇上。" }
                ]
            },
            {
                id: 3,
                title: "第三章：美好瞬间",
                subtitle: "圣诞树下的合影",
                background: "user_input_files/3.png",
                story: "巨大的圣诞树下，艾德里安举起手机，想要为这个特别的时刻留下美好的回忆。彩灯闪烁，雪花飘舞，这一刻如同童话般梦幻...",
                aiIntro: [
                    { character: "艾德里安", text: "来，我们在这里拍张照片吧。这棵圣诞树太美了，我们不能让这个瞬间溜走。" },
                    { character: "艾德里安", text: "你笑得很美...这个世界上，再没有比此刻更美好的画面了。" }
                ]
            },
            {
                id: 4,
                title: "第四章：旋转木马",
                subtitle: "童真与浪漫",
                background: "user_input_files/4.png",
                story: "华丽的旋转木马在灯光中缓缓转动，童话般的音乐响起。艾德里安牵起你的手，一起坐上了这充满魔法的木马，感受着童真与浪漫的交织...",
                aiIntro: [
                    { character: "艾德里安", text: "小时候我就梦想着能和一个特别的人一起坐旋转木马。现在，这个梦想实现了。" },
                    { character: "艾德里安", text: "你愿意和我一起回到那个充满童话的世界吗？在这里，我们可以忘记一切烦恼。" }
                ]
            },
            {
                id: 5,
                title: "第五章：欢乐时光",
                subtitle: "木马前的自拍",
                background: "user_input_files/5.png",
                story: "木马前的灯光闪烁，艾德里安兴奋地拉着你一起自拍。你们的笑容在镜头中闪闪发光，如同夜空中最亮的星星...",
                aiIntro: [
                    { character: "艾德里安", text: "再来一张自拍！这个角度的你太美了，我想把这些美好的瞬间都保存下来。" },
                    { character: "艾德里安", text: "和你在一起的每一刻，都值得被记录下来。这是我们专属的回忆。" }
                ]
            },
            {
                id: 6,
                title: "第六章：心动时刻",
                subtitle: "深情一吻",
                background: "user_input_files/6.png",
                story: "在旋转木马的璀璨灯光下，你们四目相对。时间仿佛静止了，心跳声清晰可闻。艾德里安缓缓靠近，给了你一个温柔而深情的吻...",
                aiIntro: [
                    { character: "艾德里安", text: "你知道吗？从见到你的第一眼起，我就知道你是那个特别的人。现在，我终于可以告诉你..." },
                    { character: "艾德里安", text: "我爱你。不是在这个魔法小镇，而是从心底深处的爱。这个吻，是我对你的承诺。" }
                ]
            },
            {
                id: 7,
                title: "第七章：烛光晚餐",
                subtitle: "浪漫用餐时光",
                background: "user_input_files/7.png",
                story: "温暖的壁炉旁，你们享用着精致的圣诞晚餐。烛光摇曳，红酒飘香，这一刻的温馨与浪漫让人陶醉...",
                aiIntro: [
                    { character: "艾德里安", text: "这顿晚餐希望你会喜欢。我特意选了这个最浪漫的位置，想和你共度这个特别的夜晚。" },
                    { character: "艾德里安", text: "看着你用餐的样子，我觉得自己是最幸福的人。希望每一天都能这样陪伴着你。" }
                ]
            },
            {
                id: 8,
                title: "第八章：惊喜礼物",
                subtitle: "爱的馈赠",
                background: "user_input_files/8.png",
                story: "晚餐进行到一半时，艾德里安神秘地从身后拿出一个精美的礼物盒。红色的包装纸在烛光下闪闪发光，上面系着金色的丝带...",
                aiIntro: [
                    { character: "艾德里安", text: "我想为你准备一个特别的礼物。这不仅仅是一个物品，而是我对你感情的表达。" },
                    { character: "艾德里安", text: "打开它的时候，希望你会喜欢。这是我精心为你挑选的，代表着我对你的爱意。" }
                ]
            },
            {
                id: 9,
                title: "第九章：拆礼物惊喜",
                subtitle: "甜蜜的惊喜",
                background: "user_input_files/9.png",
                story: "你小心翼翼地打开礼物盒，里面是一条精美的项链，在烛光下散发着温柔的光芒。更令你惊喜的是，礼物盒中还放着一张写着爱意的小卡片...",
                aiIntro: [
                    { character: "艾德里安", text: "希望你会喜欢这条项链。就像我说的，它代表着我对你的爱意和承诺。" },
                    { character: "艾德里安", text: "看到你开心的样子，我觉得所有的准备都是值得的。你就是我的整个世界。" }
                ]
            },
            {
                id: 10,
                title: "第十章：堆雪人",
                subtitle: "童趣时光",
                background: "user_input_files/10.png",
                story: "晚餐后，你们来到了雪后的庭院。月光洒在雪地上，一切都显得那么宁静美好。艾德里安提议一起堆一个雪人，你们开始动手...",
                aiIntro: [
                    { character: "艾德里安", text: "来，我们一起堆个雪人！小时候我很喜欢堆雪人，现在想和你一起重温那份童真。" },
                    { character: "艾德里安", text: "这个雪人就像我们一样，经历了雪的洗礼后，变得更加美丽和坚固。" }
                ]
            },
            {
                id: 11,
                title: "第十一章：雪人装饰",
                subtitle: "完美的点缀",
                background: "user_input_files/11.png",
                story: "雪人的身体堆好了，艾德里安从怀里拿出一顶黑色的礼帽，轻柔地戴在雪人的头上。这个小细节让整个雪人瞬间变得更加生动有趣...",
                aiIntro: [
                    { character: "艾德里安", text: "你看，戴上这顶帽子，我们的雪人是不是更有气质了？它现在就像个真正的绅士。" },
                    { character: "艾德里安", text: "就像你给我带来的改变一样，让我的生活变得更加完美和有意义。" }
                ]
            },
            {
                id: 12,
                title: "第十二章：雪中起舞",
                subtitle: "永恒的爱",
                background: "user_input_files/12.png",
                story: "雪花再次飘落，你们手牵着手在庭院中翩翩起舞。没有音乐，但你们的心跳就是最美的节拍。这个圣诞夜，将成为你们一生中最美好的回忆...",
                aiIntro: [
                    { character: "艾德里安", text: "谢谢你陪我度过这个最美好的圣诞夜。无论这是梦境还是现实，你都是我此生最珍贵的人。" },
                    { character: "艾德里安", text: "我们的故事才刚刚开始。让我用一生的时间，来爱你，守护你。这是我对你的承诺。" }
                ]
            }
        ];

        // 当前章节索引
        let currentChapterIndex = 0;
        let dialogueStarted = false;
        let initialDialogue = true;  // 用于控制首次对话
        let interactionMode = null;  // 'dialogue' 或 'options'
        let currentQuestionIndex = 0;  // 选项模式当前问题索引
        let optionQuestions = {};  // 存储每个章节的选项问题

        // 初始化
        function init() {
            console.log('🚀 开始初始化应用...');
            
            try {
                console.log('❄️ 创建雪花效果...');
                createSnowflakes();
                
                console.log('🔗 绑定选择界面事件...');
                bindChoiceEvents();
                
                console.log('🔗 绑定主界面事件...');
                bindEvents();
                
                console.log('✅ 应用初始化完成');
                // 不自动开始对话，等待用户选择互动方式
            } catch (error) {
                console.error('❌ 初始化过程出错:', error);
            }
        }

        // 创建雪花效果
        function createSnowflakes() {
            const container = document.getElementById('snowfallContainer');
            const snowflakeCount = 50;

            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.innerHTML = '❄';
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                snowflake.style.animationDelay = Math.random() * 2 + 's';
                snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                container.appendChild(snowflake);
            }
        }

        // 更新章节
        function updateChapter() {
            const chapter = chapters[currentChapterIndex];
            
            // 更新背景
            const container = document.getElementById('novelContainer');
            container.style.backgroundImage = `url('${chapter.background}')`;
            
            // 更新标题
            document.getElementById('chapterTitle').textContent = chapter.title;
            document.getElementById('chapterSubtitle').textContent = chapter.subtitle;
            
            // 更新故事文本（开场白）
            const storyText = document.getElementById('storyText');
            storyText.style.opacity = '0';
            setTimeout(() => {
                storyText.textContent = chapter.story;
                storyText.style.display = 'block';
                storyText.style.opacity = '1';
            }, 300);
            
            // 更新进度条
            const progress = ((currentChapterIndex + 1) / chapters.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // 清空对话并重置状态
            document.getElementById('dialogueContainer').innerHTML = '';
            dialogueStarted = false;
            initialDialogue = true;
            currentQuestionIndex = 0;
            
            // 隐藏状态提示和思考动画
            hideStatus();
            hideThinking();
            
            // 如果是对话模式，重置对话历史
            if (interactionMode === 'dialogue') {
                conversationHistory = [];
            }
            
            // 显示继续按钮
            document.getElementById('continueButton').classList.remove('hidden');
        }

        // 开始对话
        function startDialogue() {
            if (dialogueStarted || interactionMode !== 'dialogue') return;
            
            dialogueStarted = true;
            const chapter = chapters[currentChapterIndex];
            const container = document.getElementById('dialogueContainer');
            
            // 隐藏开场白
            const storyText = document.getElementById('storyText');
            storyText.style.opacity = '0';
            
            // 隐藏继续按钮
            document.getElementById('continueButton').classList.add('hidden');
            
            // 添加AI介绍对话
            setTimeout(() => {
                chapter.aiIntro.forEach((line, index) => {
                    setTimeout(() => {
                        addDialogue('艾德里安', line.text);
                    }, index * 1500);
                });
            }, 1000);
        }

        // 添加对话（单条显示）
        function addDialogue(character, text, isUser = false) {
            const container = document.getElementById('dialogueContainer');
            // 清空之前的对话，只显示当前一条
            container.innerHTML = '';
            
            const dialogueDiv = document.createElement('div');
            dialogueDiv.className = `dialogue-bubble ${isUser ? 'dialogue-user' : 'dialogue-ai'}`;
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'character-name';
            nameDiv.textContent = character;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'bubble';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'dialogue-text';
            textDiv.textContent = text;
            
            bubbleDiv.appendChild(textDiv);
            dialogueDiv.appendChild(nameDiv);
            dialogueDiv.appendChild(bubbleDiv);
            
            container.appendChild(dialogueDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 继续到下一章
        function nextChapter() {
            if (currentChapterIndex < chapters.length - 1) {
                currentChapterIndex++;
                updateChapter();
                
                // 根据互动模式启动相应互动
                setTimeout(() => {
                    if (interactionMode === 'dialogue') {
                        startDialogue();
                    } else if (interactionMode === 'options') {
                        startOptionInteraction();
                    }
                }, 1000);
            } else {
                // 故事结束
                hideStatus();
                hideThinking();
                alert('恭喜你完成了这个浪漫的圣诞故事！🎄✨');
            }
        }

        // 开始选项互动
        function startOptionInteraction() {
            if (dialogueStarted || interactionMode !== 'options') return;
            
            dialogueStarted = true;
            const chapter = chapters[currentChapterIndex];
            
            // 隐藏开场白
            const storyText = document.getElementById('storyText');
            storyText.style.opacity = '0';
            
            // 隐藏继续按钮
            document.getElementById('continueButton').classList.add('hidden');
            
            // 显示选项问题
            showOptionQuestion();
        }

        // 显示选项问题
        function showOptionQuestion() {
            const chapter = chapters[currentChapterIndex];
            const container = document.getElementById('dialogueContainer');
            container.innerHTML = '';
            
            // 获取当前章节的选项问题
            const questions = getOptionQuestions(chapter.id);
            if (currentQuestionIndex >= questions.length) {
                // 所有问题都回答完了，显示AI回应并显示继续按钮
                showAIResponse();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            // 显示AI引入对话
            setTimeout(() => {
                addDialogue('艾德里安', question.question);
            }, 500);
            
            // 显示选项按钮
            setTimeout(() => {
                showOptionButtons(question.options);
            }, 2000);
        }

        // 显示选项按钮
        function showOptionButtons(options) {
            const container = document.getElementById('dialogueContainer');
            
            options.forEach((option, index) => {
                const optionButton = document.createElement('div');
                optionButton.className = 'option-button';
                optionButton.style.color = '#FFFFFF';
                optionButton.textContent = option.text;
                optionButton.addEventListener('click', () => {
                    selectOption(option.response);
                });
                
                container.appendChild(optionButton);
            });
        }

        // 选择选项
        function selectOption(response) {
            // 显示用户选择
            const container = document.getElementById('dialogueContainer');
            container.innerHTML = '';
            
            addDialogue('你', response, true);
            
            // 移动到下一个问题
            currentQuestionIndex++;
            
            // 延迟显示下一个问题
            setTimeout(() => {
                showOptionQuestion();
            }, 2000);
        }

        // 显示AI回应
        function showAIResponse() {
            const chapter = chapters[currentChapterIndex];
            
            // 显示AI最终回应
            setTimeout(() => {
                const responses = [
                    "你的选择让我更加了解你了。我们真的是天生一对。",
                    "和你一起做出这些决定的感觉很棒。我们真的很合拍。",
                    "你的每一个选择都让我更加爱你。这就是命运的安排吧。"
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                addDialogue('艾德里安', response);
                
                // 3秒后显示继续按钮
                setTimeout(() => {
                    document.getElementById('continueButton').classList.remove('hidden');
                }, 3000);
            }, 1000);
        }

        // 获取选项问题
        function getOptionQuestions(chapterId) {
            if (!optionQuestions[chapterId]) {
                optionQuestions[chapterId] = generateQuestionsForChapter(chapterId);
            }
            return optionQuestions[chapterId];
        }

        // 为章节生成选项问题
        function generateQuestionsForChapter(chapterId) {
            const questionSets = {
                1: [
                    {
                        question: "面对这个奇幻的圣诞小镇，你的第一感觉是？",
                        options: [
                            { text: "有点害怕，但很兴奋", response: "其实我也有点紧张，但和你在一起感觉很安心。" },
                            { text: "充满好奇，想探索这里", response: "是啊，这里真的很神奇。我们一起去探索吧！" },
                            { text: "担心回不去原来的世界", response: "不用担心，无论在哪里，只要和你在一起就是最好的世界。" }
                        ]
                    },
                    {
                        question: "艾德里安向你自我介绍，你会？",
                        options: [
                            { text: "礼貌地介绍自己", response: "很高兴认识你，艾德里安。我也很高兴遇见你。" },
                            { text: "询问他的身份和来历", response: "我也很想知道关于你的一切。不过，现在更想和你一起享受这个时刻。" },
                            { text: "保持警惕，观察他的反应", response: "你的谨慎让我更加欣赏你。真的，我只想和你度过美好的时光。" }
                        ]
                    }
                ],
                2: [
                    {
                        question: "圣诞集市里弥漫着各种香味，你会？",
                        options: [
                            { text: "被甜美的饼干香味吸引", response: "我也闻到了！你想一起去尝尝那些美味的小点心吗？" },
                            { text: "寻找热红酒的温暖味道", response: "好主意！喝点热红酒让我们更暖和。一起去找最好的摊位吧！" },
                            { text: "欣赏圣诞树的香气", response: "那些常青树的味道确实很棒。这个圣诞氛围真的很浪漫。" }
                        ]
                    },
                    {
                        question: "艾德里安提议一起喝热红酒，你会？",
                        options: [
                            { text: "很高兴地接受", response: "太好了！和你一起品尝这些美味，是多么美好的体验。" },
                            { text: "询问红酒的成分", response: "你很细心呢！这些是用优质香料调制的暖身饮品，很安全。" },
                            { text: "建议先看看其他摊位", response: "你的想法很好！我们先逛逛，然后再来享受红酒。" }
                        ]
                    }
                ],
                3: [
                    {
                        question: "艾德里安想为你拍照，你会？",
                        options: [
                            { text: "自信地展现自己", response: "你真的很美！每一张照片都是艺术品。" },
                            { text: "有些害羞但很开心", response: "你的害羞样子也很可爱！我想记录下你所有的美好瞬间。" },
                            { text: "提议一起合影", response: "好主意！我们应该留下两个人的美好回忆。" }
                        ]
                    },
                    {
                        question: "照片拍完后，你会？",
                        options: [
                            { text: "关心照片的效果", response: "每一张都很棒！特别是你笑起来的样子。" },
                            { text: "感谢艾德里安的用心", response: "不用谢，能为你做这些是我的荣幸。" },
                            { text: "想看看其他拍摄角度", response: "当然！我们尝试不同的角度和姿势。" }
                        ]
                    }
                ],
                4: [
                    {
                        question: "看到旋转木马，你的第一反应是？",
                        options: [
                            { text: "童心大发，想要体验", response: "太好了！让我带你找回童年的快乐。" },
                            { text: "觉得有点幼稚但有趣", response: "有时候幼稚一点也很美好，特别是和你一起。" },
                            { text: "担心安全性", response: "别担心，我会一直陪着你，保护你的安全。" }
                        ]
                    },
                    {
                        question: "艾德里安邀请你一起坐木马，你会？",
                        options: [
                            { text: "兴奋地接受邀请", response: "太好了！我想和你一起体验这种童话般的浪漫。" },
                            { text: "犹豫但最终同意", response: "我理解你的犹豫，但相信我，这会是很美妙的体验。" },
                            { text: "建议先观察一下", response: "你的谨慎很可爱。让我们先欣赏一下它的美丽。" }
                        ]
                    }
                ],
                5: [
                    {
                        question: "木马前的灯光闪烁，你觉得？",
                        options: [
                            { text: "非常浪漫", response: "是的，这些灯光为我们的时光增添了更多浪漫色彩。" },
                            { text: "像在童话世界里", response: " именно！我们现在就像在童话故事里一样。" },
                            { text: "有点炫目但很美", response: "的确很美，就像你一样，光彩夺目。" }
                        ]
                    },
                    {
                        question: "艾德里安提议一起自拍，你会？",
                        options: [
                            { text: "积极配合，摆好姿势", response: "你总是能摆出最美的姿势！我们一定很上镜。" },
                            { text: "担心表情不够好", response: "你怎么样都美！不用担心这些问题。" },
                            { text: "提议换个更好的角度", response: "好主意！我们找到最美的角度来记录这个瞬间。" }
                        ]
                    }
                ],
                6: [
                    {
                        question: "在旋转木马的灯光下，你们四目相对，你会？",
                        options: [
                            { text: "心跳加速，感到紧张", response: "我也心跳加速了。你的眼神让我沉醉。" },
                            { text: "害羞地低下头", response: "你的害羞让我更加心动。我想保护你这份纯真。" },
                            { text: "勇敢地与他对视", response: "你的勇敢让我更加爱慕你。我想告诉你我的真心话。" }
                        ]
                    },
                    {
                        question: "当艾德里安要吻你时，你会？",
                        options: [
                            { text: "闭上眼睛，静静等待", response: "那个吻充满了我对你的爱意。" },
                            { text: "有些紧张但充满期待", response: "我感受到了你的紧张，让我来温柔地对待你。" },
                            { text: "主动回应这个吻", response: "你的主动让我感动。这个吻是我们心与心的交流。" }
                        ]
                    }
                ],
                7: [
                    {
                        question: "看到烛光晚餐的安排，你的第一印象是？",
                        options: [
                            { text: "非常感动，觉得很浪漫", response: "看到你感动我很高兴。你值得拥有最浪漫的一切。" },
                            { text: "有点紧张，担心不够完美", response: "别担心，和你在一起就已经是完美的了。" },
                            { text: "好奇会是什么样的惊喜", response: "你马上就会知道了。我希望你会喜欢这个惊喜。" }
                        ]
                    },
                    {
                        question: "用餐过程中，艾德里安为你倒酒，你会？",
                        options: [
                            { text: "感谢他的贴心", response: "不客气。能为你服务是我的荣幸。" },
                            { text: "赞美红酒的香味", response: "你的品味很好。这确实是一款优质的酒。" },
                            { text: "关心他的用餐感受", response: "你的关心让我感到温暖。我们一起享受这顿晚餐吧。" }
                        ]
                    }
                ],
                8: [
                    {
                        question: "看到艾德里安神秘的礼物，你会？",
                        options: [
                            { text: "充满好奇，想立即知道里面是什么", response: "你的好奇心很可爱！不过要等一会儿才能揭晓答案。" },
                            { text: "有点紧张，担心礼物太贵重", response: "别紧张，这只是我对你心意的表达。" },
                            { text: "感谢他的用心", response: "你的感谢比任何礼物都珍贵。" }
                        ]
                    },
                    {
                        question: "艾德里安请你打开礼物，你会？",
                        options: [
                            { text: "小心翼翼地打开", response: "你打开礼物的方式很优雅。我希望能给你惊喜。" },
                            { text: "兴奋地拆开包装", response: "你的兴奋感染了我！看到你这么开心我也很高兴。" },
                            { text: "先猜测一下里面是什么", response: "你很有意思！不管里面是什么，都代表我对你的爱。" }
                        ]
                    }
                ],
                9: [
                    {
                        question: "看到美丽的项链，你的第一反应是？",
                        options: [
                            { text: "被它的美丽深深吸引", response: "它和你真的很配，就像为你量身定做的一样。" },
                            { text: "担心这礼物太贵重", response: "别担心价格，它比不上你在我心中的价值。" },
                            { text: "感动于艾德里安的用心", response: "你的感动让我觉得所有准备都是值得的。" }
                        ]
                    },
                    {
                        question: "阅读卡片上的内容，你会？",
                        options: [
                            { text: "眼眶湿润，深深感动", response: "你的眼泪让我心疼，但也是开心的眼泪。" },
                            { text: "大声读出内容", response: "你的声音让我的话语更有力量。" },
                            { text: "害羞地收起卡片", response: "你的害羞让这个时刻更加甜蜜可爱。" }
                        ]
                    }
                ],
                10: [
                    {
                        question: "看到雪后的庭院，你的感受是？",
                        options: [
                            { text: "宁静而美丽", response: "是的，这个雪夜真的很宁静美好。" },
                            { text: "想立即投入雪中玩耍", response: "你的童心让我也想和你一起玩雪。" },
                            { text: "担心会弄脏鞋子", response: "没关系，脱掉鞋子也可以。快乐比鞋子更重要。" }
                        ]
                    },
                    {
                        question: "艾德里安提议堆雪人，你会？",
                        options: [
                            { text: "兴奋地开始堆雪球", response: "你的热情感染了我！我们一起堆个完美的雪人。" },
                            { text: "担心堆不好", response: "别担心，我们一起努力就会成功的。" },
                            { text: "建议先计划雪人的样子", response: "你的想法很好！我们先想象一下雪人的样子。" }
                        ]
                    }
                ],
                11: [
                    {
                        question: "看到艾德里安为雪人戴帽子，你会？",
                        options: [
                            { text: "觉得这个细节很贴心", response: "你的观察力很好。我想让我们的雪人更完美。" },
                            { text: "觉得很有趣", response: "你笑得很可爱！我们的雪人现在更有气质了。" },
                            { text: "担心会弄脏帽子", response: "别担心，帽子可以清洗。但这个回忆是无价的。" }
                        ]
                    },
                    {
                        question: "欣赏完成的雪人，你会？",
                        options: [
                            { text: "觉得它很可爱", response: "是啊，它就像我们一样，完美而独特。" },
                            { text: "想起童年的美好时光", response: "童年时光很美好，但现在和你一起创造的回忆更加珍贵。" },
                            { text: "觉得很有成就感", response: "我们的合作总是那么完美。这个雪人是我们的杰作。" }
                        ]
                    }
                ],
                12: [
                    {
                        question: "雪花再次飘落，你的感觉是？",
                        options: [
                            { text: "浪漫到极致", response: "是的，这个时刻太浪漫了。让我们一起享受。" },
                            { text: "觉得像在梦里", response: "也许这就是圣诞魔法的力量，让美梦成真。" },
                            { text: "担心雪花会停", response: "不管雪花是否飘落，这个美好的回忆会永远留在我们心中。" }
                        ]
                    },
                    {
                        question: "艾德里安邀请你跳舞，你会？",
                        options: [
                            { text: "优雅地接受邀请", response: "你的优雅让我着迷。让我们一起翩翩起舞。" },
                            { text: "担心不会跳舞", response: "别担心，跟着我的节奏就好。重要的是我们的心在一起。" },
                            { text: "兴奋地和他一起跳", response: "你的热情让这个夜晚更加完美。让我们永远跳下去。" }
                        ]
                    }
                ]
            };
            
            return questionSets[chapterId] || [
                {
                    question: "面对这个美好的时刻，你最想说什么？",
                    options: [
                        { text: "谢谢你陪我度过这个美好的时光", response: "不客气，能和你在一起是我的幸福。" },
                        { text: "希望时间能永远停在这一刻", response: "我也希望能永远和你在一起。" },
                        { text: "我觉得这是最浪漫的圣诞夜", response: "是的，这将是我们最美好的回忆。" }
                    ]
                }
            ];
        }

        // AI回复逻辑
        function getAIResponse(userInput) {
            const responses = {
                // 穿越相关
                '你好': '很高兴认识你！我是艾德里安。看起来我们一起被某种魔法带到了这个神奇的地方。',
                '我是': '你的声音很甜美。能告诉我你的名字吗？',
                '这里是哪里': '我也不太确定，但这里真的很美。也许这是一个圣诞魔法小镇，专门为相爱的人而存在。',
                '这是梦吗': '如果是梦，我希望能永远不要醒来。因为和你在一起的每一刻都是真实的快乐。',
                
                // 集市相关
                '这红酒': '你尝起来怎么样？我特意选了最好的香料，希望你会喜欢。在这个寒冷的夜晚，它能温暖我们的心。',
                '真香': '是啊，空气中都是圣诞的味道。能和你一起分享这些美好，真是太好了。',
                '谢谢': '不用谢，能为你做这些是我的荣幸。你开心我就开心。',
                '很温暖': '看到你温暖的样子，我也感到很温暖。和你在一起，总是感觉特别好。',
                
                // 拍照相关
                '拍得怎么样': '你总是那么美，怎么拍都好看。这张照片会成为我最珍贵的回忆。',
                '好看': '你比我见过的任何风景都要美丽。包括这个美丽的圣诞小镇。',
                '再来一张': '当然！我想记录下我们在一起的每一个美好瞬间。',
                '谢谢': '能和你一起创造回忆，是我的幸运。',
                
                // 旋转木马相关
                '很美': '是啊，就像童话故事一样美丽。能和你一起体验这种魔法的感觉，太棒了。',
                '真好玩': '看到你开心的样子，我也很兴奋。能找回童年的感觉真好，特别是和你一起。',
                '像梦一样': '也许这就是圣诞魔法，让美梦成真。能和你在同一个梦里，真是太好了。',
                '想再玩一次': '当然！只要你喜欢，我们可以在这里玩多久都行。',
                
                // 告白相关
                '我也': '真的吗？你愿意做我的女朋友吗？在这个魔法的小镇上，让我们开始一段美好的爱情故事。',
                '什么': '我说我爱你。从心底深处的爱。这个圣诞节，我将用一生的时间来爱你。',
                '爱': '你的回答让我心跳加速。能得到你的爱，是我此生最大的幸福。',
                '真的吗': '当然是真的。在魔法小镇里，我们的感情是纯真而真实的。',
                
                // 晚餐相关
                '很浪漫': '看到你喜欢这个安排，我很高兴。我特意选了这个最浪漫的位置，想和你共度这个特别的夜晚。',
                '很好吃': '你吃得开心我就满足了。能陪你一起用餐，是我的荣幸。',
                '谢谢你的晚餐': '不用谢。能和你一起享受这顿晚餐，是我的幸福。希望每一天都能这样陪伴着你。',
                '真美': '你比我见过的任何美景都要美。特别是你微笑的时候。',
                
                // 礼物相关
                '好漂亮': '看到你喜欢这个礼物，我很高兴。这代表着我对你的爱意和承诺。',
                '这是什么': '打开它你就知道了。我相信你会喜欢的。这是我精心为你挑选的。',
                '太贵重了': '不贵的礼物配不上你的美丽。这份礼物承载着我对你深深的爱意。',
                '我很喜欢': '那我就放心了。能收到你的笑容，就是我最大的快乐。',
                
                // 雪人相关
                '堆雪人': '堆雪人让我想起了童年。现在想和你一起重温那份童真和快乐。',
                '好冷': '来，我温暖你的手。在这个雪夜里，让我们的心彼此温暖。',
                '真有趣': '是啊，和你一起做任何事都很有趣。这个雪人就像我们一样，经历了雪的洗礼后变得更加美丽。',
                '成功了': '是的！我们的雪人很完美，就像我们一样。独一无二而美丽。',
                
                // 结尾相关
                '永远在一起': '是的，永远在一起。我会用一生的时间来爱你，保护你。这是我对你的承诺。',
                '最美的夜': '是的，这个圣诞夜将是我们一生中最美好的回忆。让我们的爱像雪花一样纯洁而永恒。',
                '爱你': '我也爱你，比任何语言都无法表达的程度。在这个魔法小镇里，我们的爱将是永恒的。',
                '我也会': '你的承诺比任何礼物都要珍贵。让我们在这个圣诞夜里，许下永恒的誓言。'
            };

            // 查找匹配的回复
            for (const [key, response] of Object.entries(responses)) {
                if (userInput.includes(key)) {
                    return response;
                }
            }

            // 默认回复
            const defaultResponses = [
                '你说得很有道理。在这个美好的夜晚，每个瞬间都值得珍惜。',
                '和你在一起的时光总是那么美好。无论说什么都很开心。',
                '你的想法总是那么温柔和美好。能遇见你是我的幸运。',
                '在这个魔法的小镇上，和你在一起的每一刻都是特别的。',
                '你的声音总是那么动人，让我感到心跳加速。'
            ];

            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        // 绑定选择界面事件
        function bindChoiceEvents() {
            console.log('🔧 开始绑定选择事件');
            
            const dialogueChoice = document.getElementById('dialogueChoice');
            const optionChoice = document.getElementById('optionChoice');
            
            console.log('📍 对话按钮元素:', dialogueChoice);
            console.log('📍 选项按钮元素:', optionChoice);
            
            if (dialogueChoice) {
                console.log('✅ 绑定对话按钮点击事件');
                dialogueChoice.addEventListener('click', () => {
                    console.log('💬 对话按钮被点击!');
                    interactionMode = 'dialogue';
                    console.log('📝 设置模式为对话');
                    startStory();
                });
            } else {
                console.error('❌ 找不到对话按钮元素!');
            }

            if (optionChoice) {
                console.log('✅ 绑定选项按钮点击事件');
                optionChoice.addEventListener('click', () => {
                    console.log('🎯 选项按钮被点击!');
                    interactionMode = 'options';
                    console.log('📝 设置模式为选项');
                    startStory();
                });
            } else {
                console.error('❌ 找不到选项按钮元素!');
            }
        }

        // 开始故事
        function startStory() {
            console.log('🎬 开始调用startStory函数');
            console.log('📋 当前交互模式:', interactionMode);
            
            try {
                // 隐藏选择界面
                const choiceInterface = document.getElementById('interactionChoice');
                if (choiceInterface) {
                    choiceInterface.style.display = 'none';
                    console.log('✅ 选择界面已隐藏');
                } else {
                    console.error('❌ 找不到选择界面元素!');
                }
                
                // 更新章节并开始
                console.log('📖 更新章节...');
                updateChapter();
                
                // 根据选择的模式开始互动
                if (interactionMode === 'dialogue') {
                    console.log('💬 启动对话模式...');
                    // 对话模式显示输入区域
                    document.getElementById('inputSection').classList.remove('hidden');
                    // 延迟启动对话
                    setTimeout(() => {
                        startDialogue();
                    }, 2000);
                } else if (interactionMode === 'options') {
                    console.log('🎯 启动选项模式...');
                    // 选项模式隐藏输入区域
                    document.getElementById('inputSection').classList.add('hidden');
                    // 延迟启动选项
                    setTimeout(() => {
                        startOptionInteraction();
                    }, 2000);
                } else {
                    console.error('❌ 未知的交互模式:', interactionMode);
                }
                
            } catch (error) {
                console.error('❌ startStory函数出错:', error);
            }
        }

        // 绑定事件
        function bindEvents() {
            // 继续按钮
            document.getElementById('continueButton').addEventListener('click', nextChapter);

            // 发送按钮
            document.getElementById('sendButton').addEventListener('click', sendMessage);

            // 输入框回车
            document.getElementById('userInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // 发送消息
        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;

            // 添加用户消息（单条显示）
            addDialogue('你', message, true);

            // 清空输入框
            input.value = '';

            // 检查是否为对话模式
            if (interactionMode === 'dialogue') {
                // 使用MiniMax API
                sendMinimaxMessage(message);
            } else {
                // 选项模式不应该调用这个函数，但为了安全起见
                setTimeout(() => {
                    document.getElementById('continueButton').classList.remove('hidden');
                }, 3000);
            }
        }

        // 发送MiniMax API消息
        async function sendMinimaxMessage(message) {
            // 显示AI正在思考
            showThinking();
            showStatus('艾德里安正在思考中...', 'loading');
            
            try {
                // 调用MiniMax API
                const response = await callMinimaxAPI(message);
                
                // 隐藏思考动画和状态
                hideThinking();
                hideStatus();
                
                // 显示AI回复
                addDialogue('艾德里安', response, false);
                
                // 3秒后显示继续按钮
                setTimeout(() => {
                    document.getElementById('continueButton').classList.remove('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('API调用失败:', error);
                
                // 隐藏思考动画和状态
                hideThinking();
                hideStatus();
                
                // 显示错误提示
                showStatus('连接错误，请稍后重试', 'error');
                
                // 显示友好的默认回复
                setTimeout(() => {
                    const fallbackResponses = [
                        '抱歉，我现在思绪有点乱。能再说一遍吗？',
                        '这个话题让我有点害羞...我们聊点别的吧？',
                        '抱歉刚才走神了。你说的很有意思。'
                    ];
                    const fallback = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                    addDialogue('艾德里安', fallback, false);
                    
                    // 3秒后显示继续按钮
                    setTimeout(() => {
                        document.getElementById('continueButton').classList.remove('hidden');
                    }, 3000);
                    
                    // 3秒后隐藏错误状态
                    setTimeout(() => {
                        hideStatus();
                    }, 3000);
                }, 1000);
            }
        }

        // 调用MiniMax API
        async function callMinimaxAPI(message) {
            const systemPrompt = `你是艾德里安，一个温柔浪漫的圣诞男主角。你有以下特征：
- 温柔体贴，总是关心用户的心情和感受
- 浪漫而有诗意，喜欢用优美的语言
- 充满圣诞氛围，经常提到雪花、灯光、温暖等元素
- 有点神秘，但很真诚
- 会用亲昵的称呼如"亲爱的"、"宝贝"等
- 每次回复保持在100字以内，简洁而深情
- 永远保持积极正面的态度

请以艾德里安的身份，用温柔浪漫的语气回应用户的话。`;

            // 构建对话历史
            const messages = [
                { role: 'system', content: systemPrompt }
            ];

            // 添加对话历史（保留最近5轮对话）
            const recentHistory = conversationHistory.slice(-10);
            messages.push(...recentHistory);

            // 添加当前用户消息
            messages.push({ role: 'user', content: message });

            const requestData = {
                model: MINIMAX_CONFIG.MODEL,
                messages: messages,
                max_tokens: 200,
                temperature: 0.8,
                stream: false
            };

            console.log('🚀 正在调用MiniMax API...');
            console.log('📡 请求数据:', requestData);

            const response = await fetch(MINIMAX_CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${MINIMAX_CONFIG.API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ API响应错误:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log('✅ API响应成功:', result);
            
            if (result.choices && result.choices.length > 0) {
                const aiResponse = result.choices[0].message.content;
                
                // 更新对话历史
                conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: aiResponse }
                );
                
                // 保持历史记录不超过20条（10轮对话）
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
                return aiResponse;
            } else {
                console.error('❌ API响应格式异常:', result);
                throw new Error('API响应格式异常');
            }
        }

        // 显示思考动画
        function showThinking() {
            const container = document.getElementById('dialogueContainer');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'dialogue-bubble';
            thinkingDiv.id = 'thinking';
            thinkingDiv.innerHTML = `
                <div class="character-name">艾德里安</div>
                <div class="thinking-animation">
                    <span>正在思考</span>
                    <div class="dots">
                        <span>.</span><span>.</span><span>.</span>
                    </div>
                </div>
            `;
            
            container.appendChild(thinkingDiv);
            container.scrollTop = container.scrollHeight;
        }

        // 隐藏思考动画
        function hideThinking() {
            const thinking = document.getElementById('thinking');
            if (thinking) {
                thinking.remove();
            }
        }

        // 显示状态提示
        function showStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator show status-${type}`;
            indicator.textContent = message;
        }

        // 隐藏状态提示
        function hideStatus() {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator';
            indicator.textContent = '';
        }

        // 启动应用
        window.addEventListener('load', init);
    </script>
</body>
</html>